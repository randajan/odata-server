import{a as f}from"./chunk-OUWZ2PU5.js";import Q from"@randajan/jet-core";import{parse as wt}from"url";import gt from"xmlbuilder";import xt from"@randajan/jet-core";var{solid:F}=xt.prop,j=new WeakMap,$t=(e,t="")=>{let o=String.jet.to(e,t+","+t);return o?"("+t+o+t+")":""},k=(e,t,o="")=>e+$t(t,o),V=(e,t,o="")=>"$metadata#"+k(e,t,o),g=(e,t="",o="")=>typeof e=="string"?e.startsWith(t)&&e.endsWith(o):!1,u=(e,t="",o="")=>g(e=String.jet.to(e),t,o)?e.slice(t.length,e.length-o.length):"",P=e=>e.endsWith("/")?e.slice(0,e.length-1):e,E=(e,t=!1)=>(e=wt(String.jet.to(e)||"/",t),F(e,"base",(e.host?(e.protocol?e.protocol+"//":"")+e.host:"")+P(e.pathname)),F(e,"toString",o=>e.base,!1),e),z=e=>e&&decodeURIComponent(e).replace(/(^["'`]+)|(["'`]+$)/g,""),Rt=["json","xml"],G=(e,t,o="json",s="")=>{let r=e.getType();(!r||!Rt.includes(r))&&(r=o),e.setHeader("Content-Type",`application/${r}`+(s?";"+s:""));let n=r==="json"?JSON.stringify(t):gt.create(t).end({pretty:!0});return e.setBody(200,n)};import{pathToRegexp as Ct}from"path-to-regexp";import Mt from"@randajan/jet-core";var C={};f(C,{default:()=>jt});var jt=async e=>{let{responder:t,model:o,gw:{url:s}}=e,r=[];for(let i in o.entitySets)await e.filter(i)&&r.push({kind:"EntitySet",name:i,url:i});let n={"@odata.context":`${s}/$metadata`,value:r};return t.setHeader("Content-Type","application/json"),t.setBody(200,JSON.stringify(n))};var M={};f(M,{default:()=>Et});var Et=async e=>{let{responder:t}=e;return t.setBody(204)};var A={};f(A,{default:()=>Tt});var Tt=async e=>{let{responder:t}=e,o=Math.max(0,Number.jet.to(await e.fetchResponseBodyRaw())),{$select:s}=await e.fetchOptions(),r={"@odata.context":e.getScopeMeta(s?Object.keys(s):""),"@odata.count":o,value:o};return t.setHeader("Content-Type","application/json;odata.metadata=minimal"),t.setBody(200,JSON.stringify(r))};var q={};f(q,{default:()=>St});var St=async e=>{let{responder:t}=e,{primaryKey:o}=await e.fetchEntity(),r=(await e.fetchResponseBodyRaw())[o],n={};return n["@odata.context"]=e.getScopeMetaEntity(),n["@odata.id"]=n["@odata.editLink"]=e.getScope(r,"'"),await e.pullResponseBody(n),t.setHeader("Content-Type","application/json;odata.metadata=minimal;odata.streaming=true;IEEE754Compatible=false;charset=utf-8"),t.setHeader("Location",e.getScope(encodeURI(r),"'")),t.setBody(201,JSON.stringify(n))};var D={};f(D,{default:()=>Bt});import"xmlbuilder";var X=async(e,t,o)=>{let s=[];for(let r in e){let{key:n,type:i,nullable:a}=e[r];!n&&t&&!await o(t,r)||s.push({"@Name":r,"@Type":i,"@Nullable":a})}return s},Bt=async e=>{let{model:t,responder:o}=e,s=t.namespace,r=[],n=[],i=[];for(let c in t.entitySets){if(!await e.filter(c))continue;let{entityType:p,primaryKey:l,props:w}=t.entitySets[c];r.push({"@Name":u(p,s+"."),Property:await X(w,c,e.filter),Key:l?{PropertyRef:{"@Name":l}}:void 0}),n.push({"@EntityType":p,"@Name":c})}for(let c in t.complexTypes){let{props:p}=t.complexTypes[c];i.push({"@Name":c,Property:await X(p)})}let a={"edmx:Edmx":{"@xmlns:edmx":"http://docs.oasis-open.org/odata/ns/edmx","@Version":"4.0","edmx:DataServices":{Schema:{"@xmlns":"http://docs.oasis-open.org/odata/ns/edm","@Namespace":t.namespace,EntityType:r,EntityContainer:{"@Name":"Context",EntitySet:n},ComplexType:i.length?i:void 0}}}};return G(o,a,"xml")};var I={};f(I,{default:()=>_t});var _t=async e=>{let{responder:t,params:o}=e,{primaryKey:s}=await e.fetchEntity(),{$select:r,$count:n}=await e.fetchOptions(),i={};if(o.hasOwnProperty("id")){if(i["@odata.context"]=e.getScopeMetaEntity(r?Object.keys(r):""),await e.pullResponseBody(i),!i.hasOwnProperty(s))throw{code:404,msg:"Not found"}}else{i["@odata.context"]=e.getScopeMeta(r?Object.keys(r):"");let a=await e.pullResponseBody([]);n&&(i["@odata.count"]=a.length),i.value=a}return t.setHeader("Content-Type","application/json;odata.metadata=minimal"),t.setBody(200,JSON.stringify(i))};var U={};f(U,{default:()=>vt});var vt=async e=>{let{responder:t}=e;if(await e.fetchEntity(),!await e.fetchResponseBodyRaw())throw{code:404,msg:"Not found"};return t.setBody(204)};var H={};f(H,{default:()=>bt});var bt=async e=>{let{responder:t}=e;if(await e.fetchEntity(),!await e.fetchResponseBodyRaw())throw{code:404,msg:"Not found"};return t.setBody(204)};var Ot=[C,M,A,q,D,I,U,H],Y=Ot,Z=["./resolvers/collections.js","./resolvers/cors.js","./resolvers/count.js","./resolvers/insert.js","./resolvers/metadata.js","./resolvers/query.js","./resolvers/remove.js","./resolvers/update.js"];var kt="./resolvers/",Pt=".js",tt={},K=tt;Z.forEach((e,t)=>{let o=e.substring(kt.length).slice(0,-Pt.length);tt[o]=Y[t].default});var{solid:x,cached:At,virtual:qt}=Mt.prop,T=class{constructor(t,o,s,r){let n=[];if(At(this,{},"regex",i=>Ct(s,n),!1),qt(this,"keys",i=>(this.regex,n),!1),x(this,"server",t,!1),x.all(this,{method:o,path:s,action:r}),x(this,"resolve",K[r]),!this.resolve)throw Error(this.msg(`action '${r}' is not one of: '${Object.keys(K).join(", ")}'`))}msg(t){return this.server.msg(`route '${this.path}' ${t}`)}test(t){return this.regex.test(t)}parseParams(t){let{action:o,regex:s,keys:r}=this,n=s.exec(t);if(!n)throw Error(this.msg(`parseParams('${t}') failed`));let i={};for(let a=0;a<r.length;a++)x(i,r[a].name,z(n[a+1]));return x(i,"count",o==="count"),i}};import W from"@randajan/jet-core";import Dt from"@randajan/jet-core";var $=["Edm.Int16","Edm.Int32","Edm.Int64","Edm.Boolean","Edm.String","Edm.Date","Edm.Single","Edm.Double","Edm.Decimal","Edm.TimeOfDay","Edm.DateTimeOffset","Edm.Byte","Edm.Binary","Edm.Duration"];var et=["$","$filter","$expand","$select","$orderby","$top","$skip","$count","$format"];var{solid:y}=Dt.prop,ot=(e,t,o,s,r)=>{let{isCollection:n,complex:i,primitive:a,name:c,model:p}=e;if(!c.startsWith("@odata"))return!r&&n?(Array.isArray(t)?t:[t]).map(l=>ot(e,l,o,s,!0)):i?i[o](t):p.convert[a](t,o,s)},S=class{constructor(t,o,s,r){y(this,"model",t,!1),y(this,"name",s),r=Object.jet.to(r);for(let c in r)y(this,c,r[c]);if(!this.type)throw Error(o("missing!",s,"type"));let n=u(this.type,"Collection(",")");y(this,"isCollection",!!n);let i=u(n||this.type,t.namespace+"."),a=t.complexTypes[i];if(i&&!a)throw Error(o(`definition missing at 'model.complexTypes.${i}'`,s,"type"));if(y(this,"primitive",a?void 0:n||this.type),y(this,"complex",a),!a&&!$.includes(this.primitive))throw Error(o(`invalid value '${this.type}' - accepts one of: '${$.join(", ")}'`,s,"type"))}convert(t,o,s){return ot(this,t,o,s)}toAdapter(t,o){return this.convert(t,"toAdapter",o)}toResponse(t,o){return this.convert(t,"toResponse",o)}};import It from"@randajan/jet-core";var{solid:h,cached:qe}=It.prop,B=class{constructor(t,o,s,r){h(this,"model",t,!1),h(this,"name",s),r=Object.jet.to(r);for(let c in r)h(this,c,r[c]);let n=this.entityType;if(!n)throw Error(o("missing!",s,"entityType"));let i=u(n,t.namespace+".");if(!i)throw Error(o(`missing namespace '${t.namespace}' prefix`,s,"entityType"));let a=t.entityTypes[i];if(!a)throw Error(o(`definition missing at 'model.entityTypes.${i}'`,s,"entityType"));h(this,"props",a),h(this,"propsList",Object.keys(a));for(let c in a)if(a[c].key){if(this.primaryKey)throw Error(o(`primaryKey is allready defined as ${this.primaryKey}`,s,c));h(this,"primaryKey",c)}if(!this.primaryKey)throw Error(o("primaryKey is missing",s))}async forProps(t){await Promise.all(this.propsList.map(o=>t(this.props[o],o)))}async mapProps(t,o=!1){let s=o?{}:[];return await this.forProps(async(r,n)=>{let i=await t(r,n);i!==void 0&&(o?s[n]=i:s.push(i))}),s}};import Ut from"@randajan/jet-core";var{cached:Ht}=Ut.prop,Kt=(e,t,o,s)=>s,R=(e,t,o,s,r,n)=>{let i={},a=(c,...p)=>o(c,s,...p);n=n||Kt,r=Object.jet.to(r);for(let c in r){let p=r[c];Ht(e,i,c,l=>n(t,a,c,p))}return e},st=async(e,t,o,s)=>{let r=await o.fetchEntity(),n=typeof e;return n!=="function"&&n!=="object"||(typeof s!="object"&&(s={}),await r.forProps(async(i,a)=>{if(!i.key&&!await o.filter(r.name,a))return;let c=i.convert(n==="function"?await e(a):e[a],t,o);c!==void 0&&(s[a]=c)})),s},L=async(e,t,o,s)=>{let r=Array.isArray(s);return e=r===Array.isArray(e)?e:r?[e]:e[0],r?(await Promise.all(e.map(async n=>{let i=await st(n,t,o);i&&s.push(i)})),s):st(e,t,o,s)};var{solid:d}=W.prop,Lt=(e,t,o,s)=>new S(e,t,o,s),Wt=(e,t,o,s)=>new B(e,t,o,s),rt=(e,t,o,s)=>R({},e,t,o,s,Lt),_=class{constructor(t,o,s){let{namespace:r,entityTypes:n,entitySets:i,complexTypes:a}=o;if(d(this,"server",t,!1),d(this,"namespace",String.jet.to(r)),!this.namespace)throw Error(this.msg("namespace missing"));let c=this.msg.bind(this);d(this,"complexTypes",R({},this,c,"complexTypes",a,rt)),d(this,"entityTypes",R({},this,c,"entityTypes",n,rt)),d(this,"entitySets",R({},this,c,"entitySets",i,Wt)),d(this,"convert",{},!1);let p=W.isRunnable(s);p||(s=Object.jet.to(s)),$.map(l=>{let w=p?(N,yt,ht)=>s(l,N,yt,ht):W.isRunnable(s[l])?s[l]:N=>N;d(this.convert,l,w)})}msg(t,...o){return o=o.join(".")||"",o&&(o="."+o),this.server.msg("model"+o+" "+t)}checkNamespace(t){return g(t,this.namespace+".")}stripNamespace(t){return u(t,this.namespace+".")}findEntity(t){let o=this.entitySets[t];if(!o)throw Error(this.msg("not found!","entitySets",t));return o}};import lt from"@randajan/jet-core";import mt from"@randajan/jet-core";import Jt from"odata-parser";import Qt from"querystring";import"@randajan/jet-core";var nt=e=>Array.isArray(e)&&e.length===2&&e[0]==="null"&&e[1]===""?null:e,it=(e,t,o,s,r)=>{let n=e||[];return n.push(J(t,s,r)),n.push(J(o,s,r)),n},Ft=e=>{let t={};if(!e)return t;for(let o of e){let s=Object.keys(o)[0];t[s]=o[s]==="desc"?-1:1}return t},Vt=e=>{let t={};if(!e)return t;for(let o of e)t[o]=1;return t},zt=e=>{if(!e)return{};let{type:t,left:o,right:s,func:r,args:n}=e;return J({type:t,left:o,right:s},r,n)},Gt=(e,t)=>{let o=e[0].type==="property"?e[0]:e[1],s=e[0].type==="literal"?e[0]:e[1];t[o.name]=new RegExp(s.value)},Xt=(e,t,o)=>{if(t.type!=="property"||t.name.indexOf("/")===-1)return e[t.name]=o;let s=t.name.split("/"),r=e[s[0]]||{};for(let n=1;n<s.length;n++)n===s.length-1?r[s[n]]=o:r[s[n]]=r[s[n]]||{};return e[s[0]]=r},J=({type:e,left:t,right:o},s,r)=>{let n={},i=a=>Xt(n,t,a);if(o.type==="literal"&&(e==="eq"&&i(nt(o.value)),e==="lt"&&i({$lt:o.value}),e==="gt"&&i({$gt:o.value}),e==="le"&&i({$lte:o.value}),e==="ge"&&i({$gte:o.value}),e==="ne"&&i({$ne:nt(o.value)})),e==="and"&&(n.$and=it(n.$and,t,o,s,r)),e==="or"&&(n.$or=it(n.$or,t,o,s,r)),e==="functioncall")switch(s){case"substringof":Gt(r,n)}return n},Yt=e=>{let t=e.search;if(!t)return;let o={};for(let s in e.query)et.includes(s)&&(o[s]=e.query[s]);if(!(Boolean.jet.to(o.$count)&&(o.$inlinecount="allpages",delete o.$count,t=Qt.stringify(o),!t)))return t=decodeURIComponent((u(t,"?")||t).replace(/\+/g," ")),o=t?Jt.parse(t):{},o.$inlinecount!=null&&(o.$count=!0,delete o.$inlinecount),o.$top&&(o.$limit=o.$top),o.$sort=Ft(o.$orderby),o.$filter=zt(o.$filter),o.$select=Vt(o.$select),o},at=(e,t,o)=>{let s=Yt(e)||{$filter:{}};return t.count&&(s.$count=!0),t.id&&(s.$filter[o]=t.id),s};var{solid:ct,cached:pt,safe:po}=mt.prop,v=class{constructor(t,o,s,r,n){let{server:i}=t;ct.all(this,{server:i,gw:t,model:o}),ct.all(this,{responder:s,filter:mt.isRunnable(n)?(a,c)=>n(this,a,c):a=>!0},!1),pt.all(this,{},{url:a=>{let c=s.getURL(),p=P(t.url.pathname);return g(c,p)?E(u(c,p),!0):{}},method:a=>s.getMethod().toLowerCase(),route:a=>i.findRoute(this.method,this.url.pathname),params:a=>this.route.parseParams(this.url.pathname)}),pt.all(this,{},{_entity:async a=>{let{entity:c}=this.params;if(await this.filter(c))return this.model.findEntity(c);throw{code:403,msg:"Forbidden"}},_options:async a=>at(this.url,this.params,(await this._entity).primaryKey),_requestBodyRaw:async a=>s.getBody(),_responseBodyRaw:async a=>{let{action:c}=this.route;if(r[c])return r[c](this);throw{code:501,msg:`Action '${c}' is not implemented`}}},!1)}getScope(t,o=""){let{gw:{url:s},params:{entity:r}}=this;return s+"/"+k(r,t,o)}getScopeMeta(t,o=""){let{gw:{url:s},params:{entity:r}}=this;return s+"/"+V(r,t,o)}getScopeMetaEntity(t,o=""){return this.getScopeMeta(t,o)+"/$entity"}async fetchEntity(){return this._entity}async fetchOptions(){return this._options}async fetchRequestBodyRaw(){return this._requestBodyRaw}async fetchResponseBodyRaw(){return this._responseBodyRaw}async pullRequestBody(t={}){return L(await this.fetchRequestBodyRaw(),"toAdapter",this,t)}async pullResponseBody(t={}){return L(await this.fetchResponseBodyRaw(),"toResponse",this,t)}};var{solid:ut}=lt.prop,b=class{constructor(t,o,s={},r=[]){let{adapter:n,filter:i,extender:a}=s;ut.all(this,{url:E(o,!1)}),ut.all(this,{server:t,fetchContext:async c=>{let p=new v(this,await t.fetchModel(),c,n,i);return lt.isRunnable(a)&&await a(p,...r),p}},!1)}msg(t){return this.server.msg(this.url.pathname+" "+t)}async resolve(t){let{server:o}=this,s;try{return t.setHeader("OData-Version","4.0"),t.setHeader("DataServiceVersion","4.0"),o.cors&&t.setHeader("Access-Control-Allow-Origin",o.cors),s=await this.fetchContext(t),await s.route.resolve(s)}catch(r){let n={code:r?.code||500,message:r?.msg||r?.message||"Unknown error",stack:r?.stack,method:t.getMethod(),target:t.getURL(),details:[]};t.setHeader("Content-Type","application/json"),t.setBody(n.code,JSON.stringify({error:n})),o.onError(s,n)}}};var{solid:ft,cached:Zt}=Q.prop,O=class{constructor(t={}){let{model:o,cors:s,converter:r,onError:n}=t,i={routes:{}};j.set(this,i),ft(this,"cors",String.jet.to(s)),Zt.all(this,i,{_model:async a=>new _(this,await(Q.isRunnable(o)?o():o),r)},!1),ft.all(this,{serve:(a,c,...p)=>{let l=new b(this,c,t,p);return(...w)=>l.resolve(a(...w))},onError:Q.isRunnable(n)?n:()=>{}},!1),this.addRoute("get","/","collections"),this.addRoute("get","/$metadata","metadata"),this.addRoute("get","/:entity/$count","count"),this.addRoute("get","/:entity\\(:id\\)","query"),this.addRoute("get","/:entity","query"),this.addRoute("delete","/:entity\\(:id\\)","remove"),this.addRoute("patch","/:entity\\(:id\\)","update"),this.addRoute("post","/:entity","insert"),this.cors&&this.addRoute("options","/(.*)","cors")}msg(t){return"OData server "+t}addRoute(t,o,s){let{routes:r}=j.get(this),n=r[t]||(r[t]=[]),i=new T(this,t,o,s);return n.push(i),i}findRoute(t,o){let r=j.get(this).routes[t]||[];for(let n of r)if(n.test(o))return n;throw{code:404,msg:"Not found"}}async fetchModel(){return this._model}};var te=/^P([0-9]+D)?(T([0-9]+H)?([0-9]+M)?([0-9]+S)?)?$/,dt=[{unit:"D",factor:864e5,group:"",patternIndex:1},{unit:"H",factor:36e5,group:"T",patternIndex:3},{unit:"M",factor:6e4,group:"T",patternIndex:4},{unit:"S",factor:1e3,group:"T",patternIndex:5}],ee=(e,t="duration'",o="'")=>{if(typeof e!="number"||isNaN(e)||e<0)return;let s=e,r="P",n="";for(let{unit:i,factor:a,group:c}of dt){let p=Math.floor(s/a);s%=a,!(p<=0)&&(c!==n&&(r+=n=c),r+=`${p}${i}`)}return t+r+o},oe=(e="",t="duration'",o="'")=>{let s=u(e,t,o).match(te);if(!s?.length)return;let r=0;for(let{factor:n,patternIndex:i}of dt){let a=parseInt(s[i],10);isNaN(a)||(r+=a*n)}return r};var Po=e=>new O(e);export{O as Server,Po as default,ee as msToTimespan,oe as timespanToMs};
//# sourceMappingURL=index.js.map
