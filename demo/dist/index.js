var d={isProd:!0,name:"@randajan/odata-server",description:"OData server with adapter for mongodb",version:"2.1.14",author:"Jan Randa",env:"prod",mode:"node",port:4002,dir:{root:"C:\\dev\\lib\\odata-server",dist:"demo/dist"}};import B from"chalk";var mt=Object.getOwnPropertyNames(Object.getPrototypeOf(B)).filter(t=>t!=="constructor"),C=class extends Function{constructor(t,e){super();let r=e||B,s=Object.setPrototypeOf(((...a)=>{console.log(r(t(a)))}).bind(),new.target.prototype);for(let a of mt)Object.defineProperty(s,a,{get:i=>new C(t,r[a]),enumerable:!1});return s}},N=(...t)=>{let e=r=>new Date().toLocaleTimeString("cs-CZ");return t=t.filter(r=>!!r).join(" "),new C(r=>`${t} | ${e()} | ${r.join(" ")}`)};var yt=!0,k=t=>{if(typeof t!="object")return t;let e={};for(let r in t){let o={enumerable:yt},s=t[r];s instanceof Array?o.get=a=>[...s]:o.value=k(s),Object.defineProperty(e,r,o)}return e},$=k(d);import{parentPort as ht}from"worker_threads";var Pe=N($.name,$.version,$.env);ht.on("message",t=>{t==="shutdown"&&process.exit(0)});process.on("uncaughtException",t=>{console.log(t.stack)});var ft=Object.defineProperty,u=(t,e)=>{for(var r in e)ft(t,r,{get:e[r],enumerable:!0})};import j from"@randajan/jet-core";import{parse as gt}from"url";import vt from"xmlbuilder";import wt from"@randajan/jet-core";import{pathToRegexp as bt}from"path-to-regexp";import Ot from"@randajan/jet-core";import"xmlbuilder";import E from"@randajan/jet-core";import Ut from"@randajan/jet-core";import Wt from"@randajan/jet-core";import Zt from"@randajan/jet-core";import st from"@randajan/jet-core";import at from"@randajan/jet-core";import te from"odata-parser";import ee from"querystring";import"@randajan/jet-core";var{solid:P}=wt.prop,x=new WeakMap,$t=(t,e="")=>{let r=String.jet.to(t,e+","+e);return r?"("+e+r+e+")":""},J=(t,e,r="")=>t+$t(e,r),Rt=(t,e,r="")=>"$metadata#"+J(t,e,r),S=(t,e="",r="")=>typeof t=="string"?t.startsWith(e)&&t.endsWith(r):!1,h=(t,e="",r="")=>S(t=String.jet.to(t),e,r)?t.slice(e.length,t.length-r.length):"",W=t=>t.endsWith("/")?t.slice(0,t.length-1):t,F=(t,e=!1)=>(t=gt(String.jet.to(t)||"/",e),P(t,"base",(t.host?(t.protocol?t.protocol+"//":"")+t.host:"")+W(t.pathname)),P(t,"toString",r=>t.base,!1),t),xt=t=>t&&decodeURIComponent(t).replace(/(^["'`]+)|(["'`]+$)/g,""),jt=["json","xml"],Et=(t,e,r="json",o="")=>{let s=t.getType();(!s||!jt.includes(s))&&(s=r),t.setHeader("Content-Type",`application/${s}`+(o?";"+o:""));let a=s==="json"?JSON.stringify(e):vt.create(e).end({pretty:!0});return t.setBody(200,a)},Z={};u(Z,{default:()=>St});var St=async t=>{let{responder:e,model:r,gw:{url:o}}=t,s=[];for(let i in r.entitySets)await t.filter(i)&&s.push({kind:"EntitySet",name:i,url:i});let a={"@odata.context":`${o}/$metadata`,value:s};return e.setHeader("Content-Type","application/json"),e.setBody(200,JSON.stringify(a))},z={};u(z,{default:()=>Tt});var Tt=async t=>{let{responder:e}=t;return e.setBody(204)},G={};u(G,{default:()=>Bt});var Bt=async t=>{let{responder:e}=t,r=Math.max(0,Number.jet.to(await t.fetchResponseBodyRaw())),{$select:o}=await t.fetchOptions(),s={"@odata.context":t.getScopeMeta(o?Object.keys(o):""),"@odata.count":r,value:r};return e.setHeader("Content-Type","application/json;odata.metadata=minimal"),e.setBody(200,JSON.stringify(s))},Q={};u(Q,{default:()=>Ct});var Ct=async t=>{let{responder:e}=t,{primaryKey:r}=await t.fetchEntity(),o=(await t.fetchResponseBodyRaw())[r],s={};return s["@odata.context"]=t.getScopeMetaEntity(),s["@odata.id"]=s["@odata.editLink"]=t.getScope(o,"'"),await t.pullResponseBody(s),e.setHeader("Content-Type","application/json;odata.metadata=minimal;odata.streaming=true;IEEE754Compatible=false;charset=utf-8"),e.setHeader("Location",t.getScope(encodeURI(o),"'")),e.setBody(201,JSON.stringify(s))},X={};u(X,{default:()=>Nt});var _=async(t,e,r)=>{let o=[];for(let s in t){let{key:a,type:i,nullable:n}=t[s];!a&&e&&!await r(e,s)||o.push({"@Name":s,"@Type":i,"@Nullable":n})}return o},Nt=async t=>{let{model:e,responder:r}=t,o=e.namespace,s=[],a=[],i=[];for(let l in e.entitySets){if(!await t.filter(l))continue;let{entityType:p,primaryKey:c,props:v}=e.entitySets[l];s.push({"@Name":h(p,o+"."),Property:await _(v,l,t.filter),Key:c?{PropertyRef:{"@Name":c}}:void 0}),a.push({"@EntityType":p,"@Name":l})}for(let l in e.complexTypes){let{props:p}=e.complexTypes[l];i.push({"@Name":l,Property:await _(p)})}let n={"edmx:Edmx":{"@xmlns:edmx":"http://docs.oasis-open.org/odata/ns/edmx","@Version":"4.0","edmx:DataServices":{Schema:{"@xmlns":"http://docs.oasis-open.org/odata/ns/edm","@Namespace":e.namespace,EntityType:s,EntityContainer:{"@Name":"Context",EntitySet:a},ComplexType:i.length?i:void 0}}}};return Et(r,n,"xml")},Y={};u(Y,{default:()=>kt});var kt=async t=>{let{responder:e,params:r}=t,{primaryKey:o}=await t.fetchEntity(),{$select:s,$count:a}=await t.fetchOptions(),i={};if(r.hasOwnProperty("id")){if(i["@odata.context"]=t.getScopeMetaEntity(s?Object.keys(s):""),await t.pullResponseBody(i),!i.hasOwnProperty(o))throw{code:404,msg:"Not found"}}else{i["@odata.context"]=t.getScopeMeta(s?Object.keys(s):"");let n=await t.pullResponseBody([]);a&&(i["@odata.count"]=n.length),i.value=n}return e.setHeader("Content-Type","application/json;odata.metadata=minimal"),e.setBody(200,JSON.stringify(i))},tt={};u(tt,{default:()=>Pt});var Pt=async t=>{let{responder:e}=t;if(await t.fetchEntity(),!await t.fetchResponseBodyRaw())throw{code:404,msg:"Not found"};return e.setBody(204)},et={};u(et,{default:()=>_t});var _t=async t=>{let{responder:e}=t;if(await t.fetchEntity(),!await t.fetchResponseBodyRaw())throw{code:404,msg:"Not found"};return e.setBody(204)},qt=[Z,z,G,Q,X,Y,tt,et],Mt=qt,At=["./resolvers/collections.js","./resolvers/cors.js","./resolvers/count.js","./resolvers/insert.js","./resolvers/metadata.js","./resolvers/query.js","./resolvers/remove.js","./resolvers/update.js"],Dt="./resolvers/",It=".js",rt={},q=rt;At.forEach((t,e)=>{let r=t.substring(Dt.length).slice(0,-It.length);rt[r]=Mt[e].default});var{solid:w,cached:Ht,virtual:Kt}=Ot.prop,Lt=class{constructor(t,e,r,o){let s=[];if(Ht(this,{},"regex",a=>bt(r,s),!1),Kt(this,"keys",a=>(this.regex,s),!1),w(this,"server",t,!1),w.all(this,{method:e,path:r,action:o}),w(this,"resolve",q[o]),!this.resolve)throw Error(this.msg(`action '${o}' is not one of: '${Object.keys(q).join(", ")}'`))}msg(t){return this.server.msg(`route '${this.path}' ${t}`)}test(t){return this.regex.test(t)}parseParams(t){let{action:e,regex:r,keys:o}=this,s=r.exec(t);if(!s)throw Error(this.msg(`parseParams('${t}') failed`));let a={};for(let i=0;i<o.length;i++)w(a,o[i].name,xt(s[i+1]));return w(a,"count",e==="count"),a}},b=["Edm.Int16","Edm.Int32","Edm.Int64","Edm.Boolean","Edm.String","Edm.Date","Edm.Single","Edm.Double","Edm.Decimal","Edm.TimeOfDay","Edm.DateTimeOffset","Edm.Byte","Edm.Binary","Edm.Duration"],Vt=["$","$filter","$expand","$select","$orderby","$top","$skip","$count","$format"],{solid:f}=Ut.prop,ot=(t,e,r,o,s)=>{let{isCollection:a,complex:i,primitive:n,name:l,model:p}=t;if(!l.startsWith("@odata"))return!s&&a?(Array.isArray(e)?e:[e]).map(c=>ot(t,c,r,o,!0)):i?i[r](e):p.convert[n](e,r,o)},Jt=class{constructor(t,e,r,o){f(this,"model",t,!1),f(this,"name",r),o=Object.jet.to(o);for(let n in o)f(this,n,o[n]);if(!this.type)throw Error(e("missing!",r,"type"));let s=h(this.type,"Collection(",")");f(this,"isCollection",!!s);let a=h(s||this.type,t.namespace+"."),i=t.complexTypes[a];if(a&&!i)throw Error(e(`definition missing at 'model.complexTypes.${a}'`,r,"type"));if(f(this,"primitive",i?void 0:s||this.type),f(this,"complex",i),!i&&!b.includes(this.primitive))throw Error(e(`invalid value '${this.type}' - accepts one of: '${b.join(", ")}'`,r,"type"))}convert(t,e,r){return ot(this,t,e,r)}toAdapter(t,e){return this.convert(t,"toAdapter",e)}toResponse(t,e){return this.convert(t,"toResponse",e)}},{solid:g,cached:ze}=Wt.prop,Ft=class{constructor(t,e,r,o){g(this,"model",t,!1),g(this,"name",r),o=Object.jet.to(o);for(let n in o)g(this,n,o[n]);let s=this.entityType;if(!s)throw Error(e("missing!",r,"entityType"));let a=h(s,t.namespace+".");if(!a)throw Error(e(`missing namespace '${t.namespace}' prefix`,r,"entityType"));let i=t.entityTypes[a];if(!i)throw Error(e(`definition missing at 'model.entityTypes.${a}'`,r,"entityType"));g(this,"props",i),g(this,"propsList",Object.keys(i));for(let n in i)if(i[n].key){if(this.primaryKey)throw Error(e(`primaryKey is allready defined as ${this.primaryKey}`,r,n));g(this,"primaryKey",n)}if(!this.primaryKey)throw Error(e("primaryKey is missing",r))}async forProps(t){await Promise.all(this.propsList.map(e=>t(this.props[e],e)))}async mapProps(t,e=!1){let r=e?{}:[];return await this.forProps(async(o,s)=>{let a=await t(o,s);a!==void 0&&(e?r[s]=a:r.push(a))}),r}},{cached:zt}=Zt.prop,Gt=(t,e,r,o)=>o,R=(t,e,r,o,s,a)=>{let i={},n=(l,...p)=>r(l,o,...p);a=a||Gt,s=Object.jet.to(s);for(let l in s){let p=s[l];zt(t,i,l,c=>a(e,n,l,p))}return t},M=async(t,e,r,o)=>{let s=await r.fetchEntity(),a=typeof t;return a!=="function"&&a!=="object"||(typeof o!="object"&&(o={}),await s.forProps(async(i,n)=>{if(!i.key&&!await r.filter(s.name,n))return;let l=i.convert(a==="function"?await t(n):t[n],e,r);l!==void 0&&(o[n]=l)})),o},A=async(t,e,r,o)=>{let s=Array.isArray(o);return t=s===Array.isArray(t)?t:s?[t]:t[0],s?(await Promise.all(t.map(async a=>{let i=await M(a,e,r);i&&o.push(i)})),o):M(t,e,r,o)},{solid:y}=E.prop,Qt=(t,e,r,o)=>new Jt(t,e,r,o),Xt=(t,e,r,o)=>new Ft(t,e,r,o),D=(t,e,r,o)=>R({},t,e,r,o,Qt),Yt=class{constructor(t,e,r){let{namespace:o,entityTypes:s,entitySets:a,complexTypes:i}=e;if(y(this,"server",t,!1),y(this,"namespace",String.jet.to(o)),!this.namespace)throw Error(this.msg("namespace missing"));let n=this.msg.bind(this);y(this,"complexTypes",R({},this,n,"complexTypes",i,D)),y(this,"entityTypes",R({},this,n,"entityTypes",s,D)),y(this,"entitySets",R({},this,n,"entitySets",a,Xt)),y(this,"convert",{},!1);let l=E.isRunnable(r);l||(r=Object.jet.to(r)),b.map(p=>{let c=l?(v,ct,dt)=>r(p,v,ct,dt):E.isRunnable(r[p])?r[p]:v=>v;y(this.convert,p,c)})}msg(t,...e){return e=e.join(".")||"",e&&(e="."+e),this.server.msg("model"+e+" "+t)}checkNamespace(t){return S(t,this.namespace+".")}stripNamespace(t){return h(t,this.namespace+".")}findEntity(t){let e=this.entitySets[t];if(!e)throw Error(this.msg("not found!","entitySets",t));return e}},I=t=>Array.isArray(t)&&t.length===2&&t[0]==="null"&&t[1]===""?null:t,H=(t,e,r,o,s)=>{let a=t||[];return a.push(O(e,o,s)),a.push(O(r,o,s)),a},re=t=>{let e={};if(!t)return e;for(let r of t){let o=Object.keys(r)[0];e[o]=r[o]==="desc"?-1:1}return e},oe=t=>{let e={};if(!t)return e;for(let r of t)e[r]=1;return e},se=t=>{if(!t)return{};let{type:e,left:r,right:o,func:s,args:a}=t;return O({type:e,left:r,right:o},s,a)},ae=(t,e)=>{let r=t[0].type==="property"?t[0]:t[1],o=t[0].type==="literal"?t[0]:t[1];e[r.name]=new RegExp(o.value)},ie=(t,e,r)=>{if(e.type!=="property"||e.name.indexOf("/")===-1)return t[e.name]=r;let o=e.name.split("/"),s=t[o[0]]||{};for(let a=1;a<o.length;a++)a===o.length-1?s[o[a]]=r:s[o[a]]=s[o[a]]||{};return t[o[0]]=s},O=({type:t,left:e,right:r},o,s)=>{let a={},i=n=>ie(a,e,n);if(r.type==="literal"&&(t==="eq"&&i(I(r.value)),t==="lt"&&i({$lt:r.value}),t==="gt"&&i({$gt:r.value}),t==="le"&&i({$lte:r.value}),t==="ge"&&i({$gte:r.value}),t==="ne"&&i({$ne:I(r.value)})),t==="and"&&(a.$and=H(a.$and,e,r,o,s)),t==="or"&&(a.$or=H(a.$or,e,r,o,s)),t==="functioncall")switch(o){case"substringof":ae(s,a)}return a},ne=t=>{let e=t.search;if(!e)return;let r={};for(let o in t.query)Vt.includes(o)&&(r[o]=t.query[o]);if(!(Boolean.jet.to(r.$count)&&(r.$inlinecount="allpages",delete r.$count,e=ee.stringify(r),!e)))return e=decodeURIComponent((h(e,"?")||e).replace(/\+/g," ")),r=e?te.parse(e):{},r.$inlinecount!=null&&(r.$count=!0,delete r.$inlinecount),r.$top&&(r.$limit=r.$top),r.$sort=re(r.$orderby),r.$filter=se(r.$filter),r.$select=oe(r.$select),r},le=(t,e,r)=>{let o=ne(t)||{$filter:{}};return e.count&&(o.$count=!0),e.id&&(o.$filter[r]=e.id),o},{solid:K,cached:L,safe:rr}=at.prop,pe=class{constructor(t,e,r,o,s){let{server:a}=t;K.all(this,{server:a,gw:t,model:e}),K.all(this,{responder:r,filter:at.isRunnable(s)?(i,n)=>s(this,i,n):i=>!0},!1),L.all(this,{},{url:i=>{let n=r.getURL(),l=W(t.url.pathname);return S(n,l)?F(h(n,l),!0):{}},method:i=>r.getMethod().toLowerCase(),route:i=>a.findRoute(this.method,this.url.pathname),params:i=>this.route.parseParams(this.url.pathname)}),L.all(this,{},{_entity:async i=>{let{entity:n}=this.params;if(await this.filter(n))return this.model.findEntity(n);throw{code:403,msg:"Forbidden"}},_options:async i=>le(this.url,this.params,(await this._entity).primaryKey),_requestBodyRaw:async i=>r.getBody(),_responseBodyRaw:async i=>{let{action:n}=this.route;if(o[n])return o[n](this);throw{code:501,msg:`Action '${n}' is not implemented`}}},!1)}getScope(t,e=""){let{gw:{url:r},params:{entity:o}}=this;return r+"/"+J(o,t,e)}getScopeMeta(t,e=""){let{gw:{url:r},params:{entity:o}}=this;return r+"/"+Rt(o,t,e)}getScopeMetaEntity(t,e=""){return this.getScopeMeta(t,e)+"/$entity"}async fetchEntity(){return this._entity}async fetchOptions(){return this._options}async fetchRequestBodyRaw(){return this._requestBodyRaw}async fetchResponseBodyRaw(){return this._responseBodyRaw}async pullRequestBody(t={}){return A(await this.fetchRequestBodyRaw(),"toAdapter",this,t)}async pullResponseBody(t={}){return A(await this.fetchResponseBodyRaw(),"toResponse",this,t)}},{solid:U}=st.prop,ce=class{constructor(t,e,r={},o=[]){let{adapter:s,filter:a,extender:i}=r;U.all(this,{url:F(e,!1)}),U.all(this,{server:t,fetchContext:async n=>{let l=new pe(this,await t.fetchModel(),n,s,a);return st.isRunnable(i)&&await i(l,...o),l}},!1)}msg(t){return this.server.msg(this.url.pathname+" "+t)}async resolve(t){let{server:e}=this,r;try{return t.setHeader("OData-Version","4.0"),t.setHeader("DataServiceVersion","4.0"),e.cors&&t.setHeader("Access-Control-Allow-Origin",e.cors),r=await this.fetchContext(t),await r.route.resolve(r)}catch(o){let s={code:o?.code||500,message:o?.msg||o?.message||"Unknown error",stack:o?.stack,method:t.getMethod(),target:t.getURL(),details:[]};t.setHeader("Content-Type","application/json"),t.setBody(s.code,JSON.stringify({error:s})),e.onError(r,s)}}},{solid:V,cached:de}=j.prop,ue=class{constructor(t={}){let{model:e,cors:r,converter:o,onError:s}=t,a={routes:{}};x.set(this,a),V(this,"cors",String.jet.to(r)),de.all(this,a,{_model:async i=>new Yt(this,await(j.isRunnable(e)?e():e),o)},!1),V.all(this,{serve:(i,n,...l)=>{let p=new ce(this,n,t,l);return(...c)=>p.resolve(i(...c))},onError:j.isRunnable(s)?s:()=>{}},!1),this.addRoute("get","/","collections"),this.addRoute("get","/$metadata","metadata"),this.addRoute("get","/:entity/$count","count"),this.addRoute("get","/:entity\\(:id\\)","query"),this.addRoute("get","/:entity","query"),this.addRoute("delete","/:entity\\(:id\\)","remove"),this.addRoute("patch","/:entity\\(:id\\)","update"),this.addRoute("post","/:entity","insert"),this.cors&&this.addRoute("options","/(.*)","cors")}msg(t){return"OData server "+t}addRoute(t,e,r){let{routes:o}=x.get(this),s=o[t]||(o[t]=[]),a=new Lt(this,t,e,r);return s.push(a),a}findRoute(t,e){let r=x.get(this).routes[t]||[];for(let o of r)if(o.test(e))return o;throw{code:404,msg:"Not found"}}async fetchModel(){return this._model}};var it=t=>new ue(t);import{ObjectId as me}from"mongodb";import T from"@randajan/jet-core";var{solid:ye}=T.prop,he=class{constructor(t){ye(this,"connect",t,!1)}optValidator(t,e,r,o){return o==="_id"?me(t):t}optValidate(t){return T.map(t,this.optValidator.bind(this),!0)}async getDB(t){return(await this.connect(t)).db(t.model.namespace)}async getCollection(t){return(await this.getDB(t)).collection(t.params.entity)}async remove(t){let e=await t.fetchOptions(),{$filter:r}=this.optValidate({$filter:e.$filter});return(await(await this.getCollection(t)).deleteOne(r)).deletedCount}async update(t){let e=await t.fetchOptions(),{$filter:r}=this.optValidate({$filter:e.$filter});return(await(await this.getCollection(t)).updateOne(r,{$set:await t.pullRequestBody({})})).matchedCount}async insert(t){let{primaryKey:e}=await t.fetchEntity(),r=await t.pullRequestBody({});e!=="_id"&&!r[e]&&(r[e]=T.uid(16));let o=await this.getCollection(t),s=await o.insertOne(r);return o.findOne({_id:s.insertedId})}async query(t){let e=await t.fetchOptions(),{$select:r,$sort:o,$skip:s,$limit:a,$filter:i}=this.optValidate(e),n=(await this.getCollection(t)).find(i,{projection:r||{}});return o&&(n=n.sort(o)),s&&(n=n.skip(s)),a&&(n=n.limit(a)),n.toArray()}async count(t){return(await this.query(t)).length}},nt=t=>new he(t);import lt from"@randajan/jet-core";var{solid:fe}=lt.prop,ge=class{constructor(t,e){fe.all(this,{request:t,response:e})}getURL(){let t=this.request;return t.originalUrl||t.url}getMethod(){return this.request.method}async getBody(){let t=this.request;return t.body?t.body:new Promise((e,r)=>{let o="";t.on("data",s=>{(o+=s).length>1e6&&r({statusCode:400,msg:"Request is too long"})}),t.on("end",s=>{try{e(o?JSON.parse(o):void 0)}catch(a){r({statusCode:400,msg:a.message})}})})}getType(){let t=this.request,e=lt.json.from(t.headers)?.accept;if(typeof e!="string")return;let r=e.includes("xml"),o=e.includes("json");if(r!==o)return r?"xml":"json"}setHeader(t,e){this.response.setHeader(t,e)}setBody(t,e){let r=this.response;r.statusCode=t,r.end(e)}},pt=(t,e)=>new ge(t,e);import{MongoClient as ve}from"mongodb";import we from"http";var m={url:"mongodb://localhost:27017"},$e={namespace:"main",entityTypes:{UserType:{_id:{type:"Edm.String",key:!0},name:{type:"Edm.String"}}},entitySets:{users:{entityType:"main.UserType"}}},Re=async t=>(m.current||(m.current=await ve.connect(m.url),m.current.on("close",e=>{delete m.current}),process.on("exit",e=>{m.current&&m.current.close()})),m.current),xe=it({model:$e,cors:"*",adapter:nt(Re),filter:async(t,e,r)=>t.test!=="test",extender:async(t,e)=>{t.test=e}});we.createServer(xe.serve(pt,"http://localhost:1337/odata","tesst")).listen(1337);
//# sourceMappingURL=index.js.map
